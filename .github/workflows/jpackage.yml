name: jpackage
on:
  push:
    branches:
      - master

jobs:
  package:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-15-intel ]
        arch: [amd64]
        include:
          - os: macos-latest
            arch: aarch64


    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: liberica
          java-version: 25
          architecture: ${{ matrix.arch }}

      - name: Make Gradle wrapper executable
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      - name: Build project
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            ./gradlew.bat clean shadowJar
          else
            ./gradlew clean shadowJar
          fi

      - name: Build macOS amd64 dmg
        if: runner.os == 'macOS' && matrix.arch == 'amd64'
        run: |
          jpackage \
              --input build/libs \
              --main-jar cogfly-1.0.jar \
              --name "Cogfly" \
              --type dmg \
              --vendor "Ambershadow" \
              --icon ./icons/icon.icns \
              --app-version 1.0 \
              --dest output/${{ runner.os }}-${{ matrix.arch }}

      - name: Build macOS aarch64 dmg
        if: runner.os == 'macOS' && matrix.arch == 'aarch64'
        run: |
          jpackage \
              --input build/libs \
              --main-jar cogfly-1.0.jar \
              --name "Cogfly" \
              --type dmg \
              --vendor "Ambershadow" \
              --icon ./icons/icon.icns \
              --app-version 1.0 \
              --dest output/${{ runner.os }}-${{ matrix.arch }}

      - name: Build MSI
        if: runner.os == 'Windows' && matrix.arch == 'amd64'
        run: |
          jpackage `
            --input build/libs `
            --main-jar cogfly-1.0.jar `
            --name Cogfly `
            --type msi `
            --vendor "Ambershadow" `
            --icon ./icons/icon.ico `
            --app-version 1.0 `
            --dest output/${{ runner.os }}-${{ matrix.arch }} `
            --win-menu `
            --win-shortcut
      - name: Build EXE
        if: runner.os == 'Windows' && matrix.arch == 'amd64'
        run: |
          jpackage `
            --input build/libs `
            --main-jar cogfly-1.0.jar `
            --name Cogfly `
            --type exe `
            --vendor "Ambershadow" `
            --icon ./icons/icon.ico `
            --app-version 1.0 `
            --dest output/${{ runner.os }}-${{ matrix.arch }} `
            --win-menu `
            --win-shortcut

      - name: Build DEB
        if: runner.os == 'Linux' && matrix.arch == 'amd64'
        run: |
          jpackage \
            --input build/libs \
            --main-jar cogfly-1.0.jar \
            --name Cogfly \
            --type deb \
            --vendor "Ambershadow" \
            --icon ./icons/icon.png \
            --app-version 1.0 \
            --dest output/${{ runner.os }}-${{ matrix.arch }} \
          

      - name: Build APPIMAGE
        if: runner.os == 'Linux' && matrix.arch == 'amd64'
        run: |
          mkdir -p output/appimage
          jpackage \
            --input build/libs \
            --main-jar cogfly-1.0.jar \
            --name Cogfly \
            --type app-image \
            --vendor "Ambershadow" \
            --icon ./icons/icon.png \
            --app-version 1.0 \
            --dest output/appimage
          cp ./icons/icon.png output/appimage/Cogfly/
          cp ./Cogfly.desktop output/appimage/Cogfly/
          cat > output/appimage/Cogfly/AppRun << 'EOF'
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          exec "$HERE/bin/Cogfly" "$@"
          EOF
          chmod +x output/appimage/Cogfly/AppRun
          sudo apt update
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ls -l output/appimage/Cogfly
          export APPIMAGE_EXTRACT_AND_RUN=1
          ./appimagetool output/appimage/Cogfly output/${{ runner.os }}-${{ matrix.arch }}/Cogfly.AppImage

      - name: Upload artifact to server
        shell: bash
        run: |
          ARTIFACT_NAME="Cogfly-${{ runner.os }}-${{ matrix.arch }}"
          OUTPUT_DIR="output/${{ runner.os }}-${{ matrix.arch }}"
          ZIP_NAME="${ARTIFACT_NAME}.zip"

          echo "Zipping $OUTPUT_DIR â†’ $ZIP_NAME"
          echo "$RUNNER_OS"
          
          echo "Uploading $ZIP_NAME"
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            powershell -Command @"
            \$OutputDir = '${OUTPUT_DIR//\//\\}' 
            \$ZipName = '${ZIP_NAME}'
            Compress-Archive -Path \"\$OutputDir\*\" -DestinationPath \$ZipName -Force
    
            \$Headers = @{ Authorization = 'Bearer ${{ secrets.COGFLY_UPLOAD_TOKEN }}' }
            Invoke-RestMethod -Uri 'https://ambershadow.dev/api/cogfly/upload-artifact/' 
              -Method Post -Headers \$Headers -Form @{
                file = Get-Item ([System.IO.Path]::Combine(\$PWD, \$ZipName))
                os = '${{ runner.os }}'
                arch = '${{ matrix.arch }}'
                commit = '${{ github.sha }}'
                run_id = '${{ github.run_id }}'
              }
            "@
          else
            zip -r "$ZIP_NAME" "$OUTPUT_DIR"
            curl -X POST https://ambershadow.dev/api/cogfly/upload-artifact/ \
              -H "Authorization: Bearer ${{ secrets.COGFLY_UPLOAD_TOKEN }}" \
              -F "file=@$ZIP_NAME"                   
              -F "os=${{ runner.os }}" \
              -F "arch=${{ matrix.arch }}" \
              -F "commit=${{ github.sha }}" \
              -F "run_id=${{ github.run_id }}"
          fi